name: Android Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'  # Latest stable with Dart 3.8+
          channel: 'stable'
          cache: true
      
      - name: Get Dependencies
        working-directory: frontend
        run: flutter pub get
      
      - name: Run Code Generation
        working-directory: frontend
        run: flutter pub run build_runner build --delete-conflicting-outputs
      
      - name: Analyze Code
        working-directory: frontend
        run: flutter analyze
      
      - name: Build APK (Release)
        working-directory: frontend
        run: flutter build apk --release --split-per-abi
      
      - name: Build APK (Fat APK)
        working-directory: frontend
        run: flutter build apk --release
      
      - name: Get Version from pubspec.yaml
        id: version
        working-directory: frontend
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Rename APK Files
        working-directory: frontend
        run: |
          VERSION=${{ steps.version.outputs.version }}
          mkdir -p ../release-apks
          
          # Rename split APKs
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk ../release-apks/dr-heal-ai-v${VERSION}-armeabi-v7a.apk || true
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk ../release-apks/dr-heal-ai-v${VERSION}-arm64-v8a.apk || true
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk ../release-apks/dr-heal-ai-v${VERSION}-x86_64.apk || true
          
          # Rename fat APK
          cp build/app/outputs/flutter-apk/app-release.apk ../release-apks/dr-heal-ai-v${VERSION}-universal.apk
      
      - name: Create Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸ¥ Dr.Heal AI - Android Release
          
          ### ðŸ“± APK Downloads
          
          **Recommended for most users:**
          - `dr-heal-ai-v${{ steps.version.outputs.version }}-arm64-v8a.apk` - For modern Android devices (64-bit ARM)
          
          **Alternative versions:**
          - `dr-heal-ai-v${{ steps.version.outputs.version }}-armeabi-v7a.apk` - For older Android devices (32-bit ARM)
          - `dr-heal-ai-v${{ steps.version.outputs.version }}-x86_64.apk` - For x86 devices/emulators
          - `dr-heal-ai-v${{ steps.version.outputs.version }}-universal.apk` - Universal APK (larger size, works on all devices)
          
          ### âœ¨ Features
          - Multi-agent AI medical consultation
          - Symptom analysis and severity assessment
          - Disease information and treatment recommendations
          - Emergency triage guidance
          - Secure authentication and conversation history
          
          ### ðŸ“‹ Requirements
          - Android 5.0 (API 21) or higher
          - Internet connection for AI consultations
          
          ### ðŸ”’ Security
          - JWT authentication
          - Encrypted local storage
          - Secure HTTPS communication
          
          ### ðŸ“– Documentation
          - [GitHub Repository](https://github.com/BeamlakTamirat/Dr-Heal-Ai)
          - [API Documentation](https://dr-heal-ai-production.up.railway.app/docs)
          
          ---
          
          **Note:** This is an AI-powered medical information tool. Always consult healthcare professionals for medical advice.
          EOF
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            release-apks/*.apk
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apks
          path: release-apks/*.apk
          retention-days: 90
      
      - name: Build Summary
        run: |
          echo "### âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**APK Files Generated:**" >> $GITHUB_STEP_SUMMARY
          echo "- dr-heal-ai-v${{ steps.version.outputs.version }}-arm64-v8a.apk" >> $GITHUB_STEP_SUMMARY
          echo "- dr-heal-ai-v${{ steps.version.outputs.version }}-armeabi-v7a.apk" >> $GITHUB_STEP_SUMMARY
          echo "- dr-heal-ai-v${{ steps.version.outputs.version }}-x86_64.apk" >> $GITHUB_STEP_SUMMARY
          echo "- dr-heal-ai-v${{ steps.version.outputs.version }}-universal.apk" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download:** Check the Artifacts section above" >> $GITHUB_STEP_SUMMARY
